# 项目架构文档

## 整体架构

AI Audio2Note 采用前后端分离的架构，使用 FastAPI 作为后端 API 服务，Electron 作为前端桌面应用。

```
┌─────────────────────────────────────────────────────────────┐
│                    AI Audio2Note 应用架构                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐    HTTP API    ┌─────────────────┐    │
│  │   Electron      │◄──────────────►│   FastAPI       │    │
│  │   前端应用       │                │   后端服务       │    │
│  │                 │                │                 │    │
│  │ • 用户界面       │                │ • REST API      │    │
│  │ • 用户交互       │                │ • 视频下载      │    │
│  │ • 状态管理       │                │ • 音频提取      │    │
│  │ • 本地存储       │                │ • 文件管理      │    │
│  └─────────────────┘                └─────────────────┘    │
│                                                             │
│  ┌─────────────────┐                ┌─────────────────┐    │
│  │   用户操作       │                │   外部服务       │    │
│  │                 │                │                 │    │
│  │ • 输入视频链接   │                │ • B站视频       │    │
│  │ • 选择分P       │                │ • YouTube视频   │    │
│  │ • 查看进度      │                │ • yt-dlp        │    │
│  │ • 管理历史      │                │ • FFmpeg        │    │
│  └─────────────────┘                └─────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈

### 后端技术栈
- **FastAPI**: 现代、快速的 Web 框架
- **uvicorn**: ASGI 服务器
- **yt-dlp**: 视频下载库
- **Pydantic**: 数据验证和序列化
- **Python 3.8+**: 编程语言

### 前端技术栈
- **Electron**: 跨平台桌面应用框架
- **HTML5/CSS3**: 界面结构 and 样式
- **JavaScript ES6+**: 交互逻辑
- **Axios**: HTTP 客户端
- **Node.js 16+**: 运行时环境

## 目录结构

```
AI_audio2note/
├── backend/                    # 后端服务
│   ├── main.py                # FastAPI 应用入口
│   ├── services/              # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── audio_downloader.py    # 音频下载核心逻辑
│   │   └── process_service.py     # 视频处理服务
│   ├── requirements.txt       # 后端依赖
│   └── build_exe.py          # 后端打包脚本
├── frontend/                  # 前端应用
│   ├── main.js               # Electron 主进程
│   ├── index.html            # 应用界面
│   ├── styles.css            # 样式文件
│   ├── renderer.js           # 渲染进程逻辑
│   ├── package.json          # 前端依赖和构建配置
│   └── assets/               # 资源文件
├── docs/                     # 文档目录
│   ├── ARCHITECTURE.md       # 架构文档
│   ├── DEVELOPMENT.md        # 开发文档
│   └── USER_GUIDE.md         # 用户指南
├── archive/                  # 旧版本文件归档
├── build.py                  # 项目构建脚本
├── start_dev.py              # 开发环境启动脚本
├── requirements.txt          # 项目依赖
└── README.md                 # 项目说明
```

## 数据流

### 1. 用户输入流程
```
用户输入视频链接 → 前端验证 → 发送API请求 → 后端处理 → 返回结果
```

### 2. 视频下载流程
```
接收URL → 验证平台支持 → 获取视频信息 → 下载视频 → 提取音频 → 保存文件
```

### 3. 错误处理流程
```
捕获异常 → 记录日志 → 返回错误信息 → 前端显示错误 → 用户重试
```

## API 设计

### 基础信息
- 基础 URL: `http://localhost:8000`
- 内容类型: `application/json`
- 字符编码: `UTF-8`

### 接口列表

#### 1. 健康检查
```
GET /health
```
**响应**:
```json
{
  "status": "healthy"
}
```

#### 2. 视频处理
```
POST /api/process/video
```
**请求体**:
```json
{
  "url": "https://www.bilibili.com/video/BV1xxx",
  "page_number": 1
}
```
**响应**:
```json
{
  "success": true,
  "files": ["/path/to/file1.mp3", "/path/to/file2.mp3"],
  "session_folder": "/path/to/session",
  "video_title": "视频标题"
}
```

## 前端架构

### 主进程 (main.js)
- 创建和管理应用窗口
- 处理系统级事件
- 与渲染进程通信

### 渲染进程 (renderer.js)
- 用户界面交互
- API 调用
- 状态管理
- 本地存储

### 进程间通信 (IPC)
- 使用 `ipcRenderer` 和 `ipcMain`
- 异步消息传递
- 错误处理

## 后端架构

### 服务层模式
- **AudioDownloader**: 负责视频下载和音频提取
- **ProcessService**: 负责业务流程协调

### 依赖注入
- 使用 FastAPI 的依赖注入系统
- 便于测试和维护
- 松耦合设计

### 异步处理
- 支持异步请求处理
- 提高并发性能
- 非阻塞 I/O

## 安全考虑

### 输入验证
- 使用 Pydantic 模型验证输入
- URL 格式验证
- 参数类型检查

### 文件安全
- 路径遍历防护
- 文件类型验证
- 权限控制

### 网络安全
- CORS 配置
- 请求频率限制
- 错误信息脱敏

## 性能优化

### 后端优化
- 异步处理
- 连接池
- 缓存机制
- 资源管理

### 前端优化
- 虚拟滚动
- 懒加载
- 资源压缩
- 内存管理

## 部署架构

### 开发环境
```
开发者机器
├── Python 环境
├── Node.js 环境
├── 后端服务 (localhost:8000)
└── 前端应用 (Electron)
```

### 生产环境
```
用户机器
├── 打包后的后端 exe
├── 打包后的前端应用
└── 系统依赖 (FFmpeg)
```

## 扩展性设计

### 水平扩展
- 微服务架构
- 负载均衡
- 分布式部署

### 功能扩展
- 插件系统
- 模块化设计
- 配置驱动

### 平台扩展
- 支持更多视频平台
- 支持更多音频格式
- 支持更多操作系统

## 监控和日志

### 日志系统
- 结构化日志
- 日志级别
- 日志轮转

### 监控指标
- API 响应时间
- 错误率
- 资源使用率

### 告警机制
- 异常检测
- 性能阈值
- 自动恢复

## 测试策略

### 单元测试
- 后端: pytest
- 前端: Jest

### 集成测试
- API 测试
- 端到端测试

### 性能测试
- 负载测试
- 压力测试
- 基准测试

## 版本控制

### Git 工作流
- 主分支: main
- 开发分支: develop
- 功能分支: feature/*
- 修复分支: hotfix/*

### 发布流程
- 版本标记
- 自动化构建
- 质量检查
- 部署验证

---

这个架构设计确保了应用的可维护性、可扩展性和高性能，同时保持了代码的清晰和模块化。
