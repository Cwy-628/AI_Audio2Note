<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Audio2Note - æµè§ˆå™¨ç‰ˆæœ¬</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸµ AI Audio2Note</h1>
            <p>è§†é¢‘ä¸‹è½½ä¸éŸ³é¢‘æå–å·¥å…· (æµè§ˆå™¨ç‰ˆæœ¬)</p>
        </header>

        <main class="main-content">
            <div class="input-section">
                <div class="url-input-group">
                    <label for="videoUrl">è§†é¢‘é“¾æ¥ï¼š</label>
                    <input 
                        type="url" 
                        id="videoUrl" 
                        placeholder="è¯·è¾“å…¥Bç«™æˆ–YouTubeè§†é¢‘é“¾æ¥..."
                        autocomplete="off"
                    >
                </div>

                <div class="page-input-group">
                    <label for="pageNumber">åˆ†Pç¼–å·ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input 
                        type="number" 
                        id="pageNumber" 
                        placeholder="ç•™ç©ºä¸‹è½½æ‰€æœ‰åˆ†P"
                        min="1"
                    >
                </div>

                <div class="button-group">
                    <button id="downloadBtn" class="btn btn-primary">
                        <span class="btn-text">å¼€å§‹ä¸‹è½½</span>
                        <span class="btn-loading" style="display: none;">ä¸‹è½½ä¸­...</span>
                    </button>
                    <button id="selectFolderBtn" class="btn btn-secondary">
                        é€‰æ‹©ä¸‹è½½æ–‡ä»¶å¤¹
                    </button>
                    <button id="testBtn" class="btn btn-info">
                        æµ‹è¯•è¿æ¥
                    </button>
                </div>
                
                <div id="downloadDirInfo" class="download-dir-info" style="display: none;">
                    <small>ä¸‹è½½ç›®å½•: <span id="currentDownloadDir">æœªé€‰æ‹©</span></small>
                </div>
            </div>

            <div class="status-section">
                <div id="statusMessage" class="status-message"></div>
                <div id="progressBar" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
            </div>

            <div class="result-section" id="resultSection" style="display: none;">
                <h3>ä¸‹è½½ç»“æœ</h3>
                <div id="resultContent"></div>
            </div>

            <div class="history-section">
                <h3>ä¸‹è½½å†å²</h3>
                <div id="historyList" class="history-list">
                    <p class="no-history">æš‚æ— ä¸‹è½½è®°å½•</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>æ”¯æŒå¹³å°ï¼šBç«™ (bilibili.com) | YouTube (youtube.com)</p>
            <p>ç‰ˆæœ¬ï¼š1.0.0 (æµè§ˆå™¨ç‰ˆæœ¬)</p>
        </footer>
    </div>

    <script>
        console.log('AI Audio2Note æµè§ˆå™¨ç‰ˆæœ¬åŠ è½½å®Œæˆ');
        
        class AudioDownloaderApp {
            constructor() {
                this.downloadDir = null;
                this.initializeElements();
                this.bindEvents();
                this.loadHistory();
                this.checkBackendHealth();
            }

            initializeElements() {
                this.videoUrlInput = document.getElementById('videoUrl');
                this.pageNumberInput = document.getElementById('pageNumber');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.selectFolderBtn = document.getElementById('selectFolderBtn');
                this.testBtn = document.getElementById('testBtn');
                this.statusMessage = document.getElementById('statusMessage');
                this.progressBar = document.getElementById('progressBar');
                this.resultSection = document.getElementById('resultSection');
                this.resultContent = document.getElementById('resultContent');
                this.historyList = document.getElementById('historyList');
                this.downloadDirInfo = document.getElementById('downloadDirInfo');
                this.currentDownloadDir = document.getElementById('currentDownloadDir');
            }

            bindEvents() {
                this.downloadBtn.addEventListener('click', () => this.handleDownload());
                this.selectFolderBtn.addEventListener('click', () => this.handleSelectFolder());
                this.testBtn.addEventListener('click', () => this.testConnection());
                
                // å›è½¦é”®ä¸‹è½½
                this.videoUrlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleDownload();
                    }
                });
            }

            async checkBackendHealth() {
                try {
                    const response = await fetch('http://localhost:8001/health');
                    if (response.ok) {
                        console.log('åç«¯æœåŠ¡æ­£å¸¸');
                    } else {
                        this.showStatus('åç«¯æœåŠ¡æœªå¯åŠ¨ï¼Œè¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡', 'error');
                    }
                } catch (error) {
                    this.showStatus('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡', 'error');
                }
            }

            async testConnection() {
                this.showStatus('æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...', 'info');
                
                try {
                    const response = await fetch('http://localhost:8001/health');
                    if (response.ok) {
                        const data = await response.json();
                        this.showStatus('åç«¯è¿æ¥æ­£å¸¸ï¼', 'success');
                        console.log('åç«¯å“åº”:', data);
                    } else {
                        this.showStatus('åç«¯è¿æ¥å¤±è´¥', 'error');
                    }
                } catch (error) {
                    this.showStatus(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                    console.error('è¿æ¥é”™è¯¯:', error);
                }
            }

            async handleDownload() {
                console.log('å¼€å§‹ä¸‹è½½å¤„ç†...');
                
                const url = this.videoUrlInput.value.trim();
                const pageNumber = this.pageNumberInput.value ? parseInt(this.pageNumberInput.value) : null;

                console.log('URL:', url);
                console.log('Page Number:', pageNumber);

                if (!url) {
                    console.log('URLä¸ºç©º');
                    this.showStatus('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                    return;
                }

                if (!this.isValidUrl(url)) {
                    console.log('URLæ ¼å¼æ— æ•ˆ');
                    this.showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥', 'error');
                    return;
                }

                console.log('å¼€å§‹è®¾ç½®åŠ è½½çŠ¶æ€...');
                this.setLoading(true);
                this.showStatus('æ­£åœ¨ä¸‹è½½è§†é¢‘...', 'info');
                this.showProgress(true);

                try {
                    console.log('ç›´æ¥è°ƒç”¨åç«¯API...');
                    
                    const response = await fetch('http://localhost:8001/api/process/video', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: url,
                            page_number: pageNumber,
                            download_dir: this.downloadDir
                        })
                    });

                    console.log('APIå“åº”çŠ¶æ€:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('APIè°ƒç”¨ç»“æœ:', result);

                    if (result.success) {
                        this.showStatus('ä¸‹è½½å®Œæˆï¼', 'success');
                        this.showResult(result);
                        this.addToHistory(url, result.video_title);
                    } else {
                        this.showStatus(`ä¸‹è½½å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                    this.showStatus(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    console.log('æ¸…ç†åŠ è½½çŠ¶æ€...');
                    this.setLoading(false);
                    this.showProgress(false);
                }
            }

            async handleSelectFolder() {
                try {
                    // æµè§ˆå™¨ç‰ˆæœ¬ï¼šä½¿ç”¨HTML5æ–‡ä»¶APIé€‰æ‹©æ–‡ä»¶å¤¹
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.webkitdirectory = true; // å…è®¸é€‰æ‹©æ–‡ä»¶å¤¹
                    input.style.display = 'none';
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(input);
                    
                    // è§¦å‘æ–‡ä»¶é€‰æ‹©
                    input.click();
                    
                    // ç­‰å¾…ç”¨æˆ·é€‰æ‹©
                    input.addEventListener('change', (event) => {
                        const files = event.target.files;
                        if (files.length > 0) {
                            // è·å–ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼Œç„¶åæå–æ–‡ä»¶å¤¹è·¯å¾„
                            const firstFile = files[0];
                            const folderPath = firstFile.webkitRelativePath.split('/')[0];
                            
                            // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½è·å–ç›¸å¯¹è·¯å¾„
                            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæç¤ºè®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥å®Œæ•´è·¯å¾„
                            const fullPath = prompt('è¯·è¾“å…¥å®Œæ•´çš„ä¸‹è½½æ–‡ä»¶å¤¹è·¯å¾„:', folderPath);
                            
                            if (fullPath) {
                                this.downloadDir = fullPath;
                                this.currentDownloadDir.textContent = fullPath;
                                this.downloadDirInfo.style.display = 'block';
                                this.showStatus(`å·²é€‰æ‹©ä¸‹è½½æ–‡ä»¶å¤¹: ${fullPath}`, 'info');
                            }
                        }
                        
                        // æ¸…ç†
                        document.body.removeChild(input);
                    });
                    
                } catch (error) {
                    this.showStatus(`é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`, 'error');
                }
            }

            isValidUrl(url) {
                // æ›´å®½æ¾çš„URLéªŒè¯ï¼Œä¸»è¦æ£€æŸ¥åŸºæœ¬æ ¼å¼
                const basicUrlPattern = /^https?:\/\/.+/;
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«æ”¯æŒçš„å¹³å°åŸŸå
                const supportedPlatforms = [
                    'bilibili.com',
                    'youtube.com',
                    'youtu.be',
                    'm.youtube.com'
                ];
                
                const urlLower = url.toLowerCase();
                const hasValidProtocol = basicUrlPattern.test(url);
                const hasSupportedDomain = supportedPlatforms.some(domain => urlLower.includes(domain));
                
                return hasValidProtocol && hasSupportedDomain;
            }

            setLoading(loading) {
                this.downloadBtn.disabled = loading;
                const btnText = this.downloadBtn.querySelector('.btn-text');
                const btnLoading = this.downloadBtn.querySelector('.btn-loading');
                
                if (loading) {
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'inline';
                } else {
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                }
            }

            showStatus(message, type) {
                this.statusMessage.textContent = message;
                this.statusMessage.className = `status-message ${type}`;
                this.statusMessage.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸå’Œé”™è¯¯æ¶ˆæ¯
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        this.statusMessage.style.display = 'none';
                    }, 3000);
                }
            }

            showProgress(show) {
                this.progressBar.style.display = show ? 'block' : 'none';
                if (show) {
                    // æ˜¾ç¤ºä¸ç¡®å®šè¿›åº¦æ¡
                    const progressFill = this.progressBar.querySelector('.progress-fill');
                    progressFill.style.width = '100%';
                    progressFill.style.animation = 'pulse 2s infinite';
                } else {
                    // åœæ­¢åŠ¨ç”»
                    const progressFill = this.progressBar.querySelector('.progress-fill');
                    progressFill.style.animation = 'none';
                }
            }

            showResult(result) {
                this.resultSection.style.display = 'block';
                
                // åˆ›å»ºæ›´å‹å¥½çš„ç»“æœæ˜¾ç¤º
                let resultText = `ä¸‹è½½å®Œæˆï¼\n\n`;
                resultText += `è§†é¢‘æ ‡é¢˜: ${result.video_title}\n`;
                resultText += `ä¿å­˜ç›®å½•: ${result.session_folder}\n\n`;
                resultText += `ä¸‹è½½çš„æ–‡ä»¶:\n`;
                
                result.files.forEach((file, index) => {
                    resultText += `${index + 1}. ${file}\n`;
                });
                
                resultText += `\nå®Œæ•´ç»“æœ:\n${JSON.stringify(result, null, 2)}`;
                
                this.resultContent.textContent = resultText;
            }

            addToHistory(url, title) {
                const history = this.getHistory();
                const newItem = {
                    url: url,
                    title: title || 'æœªçŸ¥æ ‡é¢˜',
                    timestamp: new Date().toLocaleString()
                };
                
                // é¿å…é‡å¤æ·»åŠ 
                const exists = history.some(item => item.url === url);
                if (!exists) {
                    history.unshift(newItem);
                    // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
                    if (history.length > 20) {
                        history.splice(20);
                    }
                    this.saveHistory(history);
                    this.renderHistory();
                }
            }

            getHistory() {
                const history = localStorage.getItem('downloadHistory');
                return history ? JSON.parse(history) : [];
            }

            saveHistory(history) {
                localStorage.setItem('downloadHistory', JSON.stringify(history));
            }

            loadHistory() {
                this.renderHistory();
            }

            renderHistory() {
                const history = this.getHistory();
                
                if (history.length === 0) {
                    this.historyList.innerHTML = '<p class="no-history">æš‚æ— ä¸‹è½½è®°å½•</p>';
                    return;
                }

                this.historyList.innerHTML = history.map(item => `
                    <div class="history-item" data-url="${item.url}">
                        <div class="title">${item.title}</div>
                        <div class="url">${item.url}</div>
                        <div class="timestamp">${item.timestamp}</div>
                    </div>
                `).join('');

                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                this.historyList.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const url = item.dataset.url;
                        this.videoUrlInput.value = url;
                        this.videoUrlInput.focus();
                    });
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨');
            new AudioDownloaderApp();
        });
    </script>
</body>
</html>
